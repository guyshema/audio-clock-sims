<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audio Clock Jitter Simulation with Sound</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            color: white;
        }
        
        h1 {
            font-size: clamp(1.3rem, 4vw, 2rem);
            margin: 15px 0 5px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .creator-credit {
            text-align: center;
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .creator-credit a {
            color: #00ff88;
            text-decoration: none;
            font-weight: bold;
        }
        
        .creator-credit a:hover {
            text-decoration: underline;
            color: #00ffaa;
        }
        
        .main-container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Audio Section */
        .audio-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #1e3c72;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .audio-player {
            display: none;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }
        
        .audio-player.active {
            display: block;
        }
        
        .playback-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .audio-status {
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .jitter-audio-control {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        .jitter-slider {
            width: 200px;
            height: 5px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            outline: none;
        }
        
        .jitter-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .jitter-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Clock Section */
        .clock-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .clocks-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .clock-unit {
            text-align: center;
        }
        
        .clock {
            position: relative;
            width: min(200px, 40vw);
            height: min(200px, 40vw);
            background: radial-gradient(circle, #0a0e27, #000);
            border-radius: 50%;
            box-shadow: 
                0 0 30px rgba(0,0,0,0.5),
                inset 0 0 20px rgba(0,0,0,0.5);
            margin: 0 auto 10px;
        }
        
        .clock-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .good-clock .clock-title {
            color: #00ff88;
        }
        
        .bad-clock .clock-title {
            color: #ff6b6b;
        }
        
        /* Clock marks */
        .tick {
            position: absolute;
            width: 2px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            left: calc(50% - 1px);
            top: 5px;
            transform-origin: center calc(100px - 5px);
        }
        
        .tick.major {
            height: 12px;
            width: 3px;
            background: rgba(255,255,255,0.6);
            left: calc(50% - 1.5px);
        }
        
        /* Sampling hand */
        .sampling-hand {
            position: absolute;
            width: 3px;
            height: 45%;
            background: linear-gradient(to top, transparent, #ffd700);
            top: 5%;
            left: calc(50% - 1.5px);
            transform-origin: center calc(100px - 5px);
            box-shadow: 0 0 10px #ffd700;
            transition: none;
        }
        
        .good-clock .sampling-hand {
            background: linear-gradient(to top, transparent, #00ff88);
            box-shadow: 0 0 10px #00ff88;
        }
        
        .bad-clock .sampling-hand {
            background: linear-gradient(to top, transparent, #ff6b6b);
            box-shadow: 0 0 10px #ff6b6b;
        }
        
        /* Center dot */
        .center-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
            z-index: 10;
        }
        
        /* Sample indicator */
        .sample-indicator {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
            top: 10px;
            left: calc(50% - 4px);
            opacity: 0;
            transform-origin: center calc(100px - 10px);
            box-shadow: 0 0 10px currentColor;
        }
        
        .sample-indicator.flash {
            animation: flash 0.3s ease-out;
        }
        
        @keyframes flash {
            0% { opacity: 0; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
            100% { opacity: 0; transform: scale(1); }
        }
        
        /* Waveform canvas */
        .waveform-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
        }
        
        canvas {
            width: 100%;
            height: 250px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        button.active {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Info panels */
        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }
        
        /* Jitter display */
        .jitter-display {
            text-align: center;
            font-size: 16px;
            margin: 10px 0;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        .jitter-value {
            font-weight: bold;
            color: #ffd700;
            font-size: 20px;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .clock {
                width: min(150px, 35vw);
                height: min(150px, 35vw);
            }
            
            .sampling-hand {
                transform-origin: center calc(75px - 5px);
            }
            
            .sample-indicator {
                transform-origin: center calc(75px - 10px);
            }
            
            .tick {
                transform-origin: center calc(75px - 5px);
            }
            
            canvas {
                height: 200px;
            }
            
            .jitter-slider {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <h1>🎛️ Audio Sampling Jitter Effect</h1>
    <div class="creator-credit">
        Created by Guy Shema Oppenheimer <a href="https://www.instagram.com/oppenmasters" target="_blank">@Oppenmasters</a>
    </div>
    
    <div class="info-panel" style="max-width: 600px; margin: 10px auto 20px; text-align: center;">
        <strong>Explanation:</strong> The hand represents the sampling moment. In a precise clock, sampling occurs at equal intervals.
        With jitter, sampling happens too early or too late, causing incorrect values to be sampled from the original wave,
        creating distortions in the reconstructed signal.
    </div>
    
    <!-- Top controls (duplicate) -->
    <div class="controls">
        <button id="playBtnTop">▶️ Play</button>
        <button id="speedBtnTop">🎚️ Speed: Normal</button>
        <button id="jitterBtnTop">📊 Jitter: 10%</button>
        <button id="resetBtnTop">🔄 Reset</button>
    </div>
    
    <div class="main-container">
        <!-- Global Jitter Control -->
        <div class="audio-section" style="padding: 15px;">
            <div class="jitter-audio-control" style="margin: 0;">
                <span style="font-weight: bold;">🎚️ Global Jitter Control:</span>
                <input type="range" class="jitter-slider" id="globalJitterSlider" 
                       min="0" max="50" value="10" style="width: 250px;">
                <span id="globalJitterValue" style="font-weight: bold; color: #ffd700; font-size: 18px;">10%</span>
            </div>
        </div>
        
        <!-- Audio Section -->
        <div class="audio-section">
            <h3>🎵 Audio Jitter Test</h3>
            <div class="audio-controls">
                <div class="file-input-wrapper">
                    <input type="file" id="audioFile" accept="audio/*">
                    <label for="audioFile" class="file-input-label">
                        📁 Choose Audio File
                    </label>
                </div>
                
                <div class="audio-status" id="audioStatus">
                    Upload an audio file to hear the jitter effect
                </div>
                
                <div class="audio-player" id="audioPlayer">
                    <div class="playback-controls">
                        <button id="playAudioBtn">▶️ Play Audio</button>
                        <button id="toggleJitterBtn" class="active">🔊 Jitter ON</button>
                    </div>
                    
                    <div class="jitter-audio-control">
                        <span>Audio Jitter:</span>
                        <input type="range" class="jitter-slider" id="audioJitterSlider" 
                               min="0" max="50" value="10">
                        <span id="audioJitterValue">10%</span>
                    </div>
                    
                    <canvas id="audioWaveform" style="width: 100%; height: 100px;"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Clock Section -->
        <div class="clock-section">
            <div class="clocks-row">
                <div class="clock-unit good-clock">
                    <div class="clock-title">✅ Precise Clock</div>
                    <div class="clock" id="goodClock">
                        <div class="ticks"></div>
                        <div class="sampling-hand" id="goodHand"></div>
                        <div class="sample-indicator" id="goodSample"></div>
                        <div class="center-dot"></div>
                    </div>
                    <div class="info-panel">
                        Sampling at fixed intervals
                    </div>
                </div>
                
                <div class="clock-unit bad-clock">
                    <div class="clock-title">⚠️ Clock with Jitter</div>
                    <div class="clock" id="badClock">
                        <div class="ticks"></div>
                        <div class="sampling-hand" id="badHand"></div>
                        <div class="sample-indicator" id="badSample"></div>
                        <div class="center-dot"></div>
                    </div>
                    <div class="info-panel">
                        Unstable sampling
                    </div>
                </div>
            </div>
            
            <div class="jitter-display">
                Jitter Level: <span class="jitter-value" id="jitterLevel">10%</span>
            </div>
        </div>
        
        <div class="clock-section">
            <h3 style="text-align: center; margin-bottom: 15px;">📊 Waveform & Samples</h3>
            <div class="waveform-container">
                <canvas id="waveform"></canvas>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4a9eff;"></div>
                    <span>Original Wave</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff88;"></div>
                    <span>Precise Samples</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    <span>Jittered Samples</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(255,255,0,0.5);"></div>
                    <span>Reconstructed (Jitter)</span>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="playBtn">▶️ Play</button>
            <button id="speedBtn">🎚️ Speed: Normal</button>
            <button id="jitterBtn">📊 Jitter: 10%</button>
            <button id="resetBtn">🔄 Reset</button>
        </div>
    </div>
    
    <script>
        // Global variables
        let isPlaying = false;
        let animationId = null;
        let time = 0;
        let speed = 1;
        let jitterAmount = 0.1;
        let sampleRate = 20;
        let lastSampleTime = { good: 0, bad: 0 };
        
        // Audio variables
        let audioContext = null;
        let audioBuffer = null;
        let sourceNode = null;
        let isAudioPlaying = false;
        let jitterEnabled = true;
        let audioJitterAmount = 0.1;
        let scriptProcessor = null;
        
        // Canvas setup
        const canvas = document.getElementById('waveform');
        const ctx = canvas.getContext('2d');
        const audioCanvas = document.getElementById('audioWaveform');
        const audioCtx = audioCanvas.getContext('2d');
        
        // Samples storage
        let goodSamples = [];
        let badSamples = [];
        const maxSamples = 50;
        
        // Initialize
        function init() {
            setupCanvas();
            addClockTicks();
            drawStaticWaveform();
            initAudio();
        }
        
        // Initialize Web Audio API
        function initAudio() {
            document.getElementById('audioFile').addEventListener('change', handleFileSelect);
            document.getElementById('playAudioBtn').addEventListener('click', toggleAudioPlayback);
            document.getElementById('toggleJitterBtn').addEventListener('click', toggleJitter);
            document.getElementById('audioJitterSlider').addEventListener('input', updateAudioJitter);
            document.getElementById('globalJitterSlider').addEventListener('input', updateGlobalJitter);
        }
        
        // Update global jitter
        function updateGlobalJitter(e) {
            const value = parseInt(e.target.value);
            document.getElementById('globalJitterValue').textContent = value + '%';
            
            // Update audio jitter
            audioJitterAmount = value / 100;
            document.getElementById('audioJitterSlider').value = value;
            document.getElementById('audioJitterValue').textContent = value + '%';
            
            // Update visual jitter
            const jitterLevels = [0, 10, 25, 50];
            const closest = jitterLevels.reduce((prev, curr) => 
                Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev
            );
            const index = jitterLevels.indexOf(closest);
            jitterAmount = closest / 100;
            
            const labels = ['0%', '10%', '25%', '50%'];
            document.getElementById('jitterBtn').textContent = `📊 Jitter: ${labels[index]}`;
            document.getElementById('jitterBtnTop').textContent = `📊 Jitter: ${labels[index]}`;
            document.getElementById('jitterLevel').textContent = labels[index];
        }
        
        // Handle file selection
        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                document.getElementById('audioStatus').textContent = `${file.name} loaded successfully`;
                document.getElementById('audioPlayer').classList.add('active');
                
                // Setup audio visualization
                setupAudioVisualization();
            } catch (error) {
                document.getElementById('audioStatus').textContent = 'Error loading file';
                console.error('Error loading audio:', error);
            }
        }
        
        // Setup audio visualization
        function setupAudioVisualization() {
            const rect = audioCanvas.getBoundingClientRect();
            audioCanvas.width = rect.width * window.devicePixelRatio;
            audioCanvas.height = rect.height * window.devicePixelRatio;
            audioCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        
        // Toggle audio playback
        function toggleAudioPlayback() {
            if (!audioBuffer) return;
            
            if (isAudioPlaying) {
                stopAudio();
                // Stop visual animation if running
                if (isPlaying) {
                    playToggle();
                }
            } else {
                playAudio();
                // Start visual animation if not running
                if (!isPlaying) {
                    playToggle();
                }
            }
        }
        
        // Play audio with jitter effect
        function playAudio() {
            if (!audioBuffer) return;
            
            // Create source
            sourceNode = audioContext.createBufferSource();
            sourceNode.buffer = audioBuffer;
            
            // Create script processor for jitter effect
            const bufferSize = 2048;
            scriptProcessor = audioContext.createScriptProcessor(bufferSize, 2, 2);
            
            let phase = 0;
            scriptProcessor.onaudioprocess = function(e) {
                const inputL = e.inputBuffer.getChannelData(0);
                const inputR = e.inputBuffer.getChannelData(1);
                const outputL = e.outputBuffer.getChannelData(0);
                const outputR = e.outputBuffer.getChannelData(1);
                
                for (let i = 0; i < bufferSize; i++) {
                    if (jitterEnabled && audioJitterAmount > 0) {
                        // Apply jitter effect
                        phase += 0.01;
                        const jitter = Math.sin(phase * 10) * audioJitterAmount * 0.001 +
                                      Math.sin(phase * 37) * audioJitterAmount * 0.0005;
                        
                        // Simulate timing variations
                        const sampleOffset = Math.floor(jitter * 44100);
                        const idx = Math.max(0, Math.min(i + sampleOffset, bufferSize - 1));
                        
                        outputL[i] = inputL[idx] * (1 - audioJitterAmount * 0.002);
                        outputR[i] = inputR[idx] * (1 - audioJitterAmount * 0.002);
                        
                        // Add subtle distortion
                        if (Math.random() < audioJitterAmount * 0.01) {
                            outputL[i] *= 0.95;
                            outputR[i] *= 0.95;
                        }
                    } else {
                        outputL[i] = inputL[i];
                        outputR[i] = inputR[i];
                    }
                }
                
                // Visualize audio
                visualizeAudio(outputL);
            };
            
            // Connect nodes
            sourceNode.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);
            
            // Start playback
            sourceNode.start();
            isAudioPlaying = true;
            document.getElementById('playAudioBtn').textContent = '⏸️ Stop Audio';
            
            sourceNode.onended = function() {
                stopAudio();
            };
        }
        
        // Stop audio
        function stopAudio() {
            if (sourceNode) {
                try {
                    sourceNode.stop();
                } catch(e) {}
                sourceNode.disconnect();
                sourceNode = null;
            }
            if (scriptProcessor) {
                scriptProcessor.disconnect();
                scriptProcessor = null;
            }
            isAudioPlaying = false;
            document.getElementById('playAudioBtn').textContent = '▶️ Play Audio';
        }
        
        // Toggle jitter
        function toggleJitter() {
            jitterEnabled = !jitterEnabled;
            const btn = document.getElementById('toggleJitterBtn');
            btn.textContent = jitterEnabled ? '🔊 Jitter ON' : '🔇 Jitter OFF';
            btn.classList.toggle('active');
        }
        
        // Update audio jitter amount
        function updateAudioJitter(e) {
            const value = parseInt(e.target.value);
            audioJitterAmount = value / 100;
            document.getElementById('audioJitterValue').textContent = value + '%';
            document.getElementById('globalJitterSlider').value = value;
            document.getElementById('globalJitterValue').textContent = value + '%';
            
            // Sync with visual jitter
            const jitterLevels = [0, 10, 25, 50];
            const closest = jitterLevels.reduce((prev, curr) => 
                Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev
            );
            const index = jitterLevels.indexOf(closest);
            jitterAmount = closest / 100;
            
            const labels = ['0%', '10%', '25%', '50%'];
            document.getElementById('jitterBtn').textContent = `📊 Jitter: ${labels[index]}`;
            document.getElementById('jitterBtnTop').textContent = `📊 Jitter: ${labels[index]}`;
            document.getElementById('jitterLevel').textContent = labels[index];
        }
        
        // Visualize audio waveform
        function visualizeAudio(data) {
            const width = audioCanvas.width / window.devicePixelRatio;
            const height = audioCanvas.height / window.devicePixelRatio;
            
            audioCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            audioCtx.fillRect(0, 0, width, height);
            
            audioCtx.strokeStyle = jitterEnabled ? '#ff6b6b' : '#00ff88';
            audioCtx.lineWidth = 2;
            audioCtx.beginPath();
            
            const sliceWidth = width / data.length;
            let x = 0;
            
            for (let i = 0; i < data.length; i++) {
                const v = data[i];
                const y = (v + 1) * height / 2;
                
                if (i === 0) {
                    audioCtx.moveTo(x, y);
                } else {
                    audioCtx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            audioCtx.stroke();
        }
        
        // Setup canvas dimensions
        function setupCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        
        // Add clock tick marks
        function addClockTicks() {
            const clocks = document.querySelectorAll('.ticks');
            clocks.forEach(clock => {
                for (let i = 0; i < 12; i++) {
                    const tick = document.createElement('div');
                    tick.className = i % 3 === 0 ? 'tick major' : 'tick';
                    tick.style.transform = `rotate(${i * 30}deg)`;
                    clock.appendChild(tick);
                }
            });
        }
        
        // Animation loop
        function animate(timestamp) {
            if (!isPlaying) return;
            
            time += 0.016 * speed;
            
            const baseAngle = (time * 60) % 360;
            const jitterOffset = Math.sin(time * 7.3) * jitterAmount * 30 + 
                               Math.sin(time * 13.7) * jitterAmount * 15 +
                               (Math.random() - 0.5) * jitterAmount * 10;
            
            document.getElementById('goodHand').style.transform = `rotate(${baseAngle}deg)`;
            document.getElementById('badHand').style.transform = `rotate(${baseAngle + jitterOffset}deg)`;
            
            const sampleInterval = 360 / sampleRate;
            const currentSampleIndex = Math.floor(baseAngle / sampleInterval);
            
            if (currentSampleIndex !== lastSampleTime.good) {
                lastSampleTime.good = currentSampleIndex;
                takeSample('good', baseAngle);
            }
            
            const badAngle = baseAngle + jitterOffset;
            const badSampleIndex = Math.floor(badAngle / sampleInterval);
            if (badSampleIndex !== lastSampleTime.bad) {
                lastSampleTime.bad = badSampleIndex;
                takeSample('bad', badAngle);
            }
            
            drawWaveform();
            
            animationId = requestAnimationFrame(animate);
        }
        
        // Take a sample
        function takeSample(type, angle) {
            const indicator = document.getElementById(type + 'Sample');
            indicator.style.transform = `rotate(${angle}deg)`;
            indicator.classList.remove('flash');
            void indicator.offsetWidth;
            indicator.classList.add('flash');
            
            const normalizedAngle = (angle % 360) / 360;
            const sampleTime = normalizedAngle * Math.PI * 2;
            const sampleValue = Math.sin(sampleTime * 2);
            
            const samples = type === 'good' ? goodSamples : badSamples;
            samples.push({
                time: normalizedAngle,
                value: sampleValue,
                angle: angle
            });
            
            if (samples.length > maxSamples) {
                samples.shift();
            }
        }
        
        // Draw waveform
        function drawWaveform() {
            const width = canvas.width / window.devicePixelRatio;
            const height = canvas.height / window.devicePixelRatio;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, width, height);
            
            const padding = 20;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;
            const centerY = height / 2;
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, centerY);
            ctx.lineTo(width - padding, centerY);
            ctx.stroke();
            
            ctx.strokeStyle = '#4a9eff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = 0; x < graphWidth; x++) {
                const t = (x / graphWidth) * Math.PI * 4;
                const y = centerY - Math.sin(t) * graphHeight * 0.4;
                if (x === 0) {
                    ctx.moveTo(padding + x, y);
                } else {
                    ctx.lineTo(padding + x, y);
                }
            }
            ctx.stroke();
            
            ctx.fillStyle = '#00ff88';
            goodSamples.forEach(sample => {
                const x = padding + sample.time * graphWidth;
                const y = centerY - sample.value * graphHeight * 0.4;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
            
            ctx.fillStyle = '#ff6b6b';
            badSamples.forEach(sample => {
                const x = padding + sample.time * graphWidth;
                const y = centerY - sample.value * graphHeight * 0.4;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
            
            if (badSamples.length > 3) {
                ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                
                const sortedBadSamples = [...badSamples].sort((a, b) => a.time - b.time);
                
                sortedBadSamples.forEach((sample, i) => {
                    const x = padding + sample.time * graphWidth;
                    const y = centerY - sample.value * graphHeight * 0.4;
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        
        // Draw static waveform
        function drawStaticWaveform() {
            const width = canvas.width / window.devicePixelRatio;
            const height = canvas.height / window.devicePixelRatio;
            
            ctx.clearRect(0, 0, width, height);
            
            const padding = 20;
            const graphWidth = width - padding * 2;
            const centerY = height / 2;
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, centerY);
            ctx.lineTo(width - padding, centerY);
            ctx.stroke();
            
            ctx.strokeStyle = '#4a9eff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = 0; x < graphWidth; x++) {
                const t = (x / graphWidth) * Math.PI * 4;
                const y = centerY - Math.sin(t) * height * 0.35;
                if (x === 0) {
                    ctx.moveTo(padding + x, y);
                } else {
                    ctx.lineTo(padding + x, y);
                }
            }
            ctx.stroke();
        }
        
        // Event listeners
        document.getElementById('playBtn').addEventListener('click', playToggle);
        document.getElementById('playBtnTop').addEventListener('click', playToggle);
        
        function playToggle() {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').textContent = isPlaying ? '⏸️ Pause' : '▶️ Play';
            document.getElementById('playBtnTop').textContent = isPlaying ? '⏸️ Pause' : '▶️ Play';
            document.getElementById('playBtn').classList.toggle('active');
            document.getElementById('playBtnTop').classList.toggle('active');
            
            // Sync with audio if loaded
            if (audioBuffer && !isAudioPlaying && isPlaying) {
                playAudio();
            } else if (isAudioPlaying && !isPlaying) {
                stopAudio();
            }
            
            if (isPlaying) {
                animate();
            } else {
                cancelAnimationFrame(animationId);
            }
        }
        
        document.getElementById('speedBtn').addEventListener('click', speedToggle);
        document.getElementById('speedBtnTop').addEventListener('click', speedToggle);
        
        function speedToggle() {
            const speeds = [0.5, 1, 2];
            const labels = ['Slow', 'Normal', 'Fast'];
            let currentIndex = speeds.indexOf(speed);
            currentIndex = (currentIndex + 1) % speeds.length;
            speed = speeds[currentIndex];
            document.getElementById('speedBtn').textContent = `🎚️ Speed: ${labels[currentIndex]}`;
            document.getElementById('speedBtnTop').textContent = `🎚️ Speed: ${labels[currentIndex]}`;
        }
        
        document.getElementById('jitterBtn').addEventListener('click', jitterToggle);
        document.getElementById('jitterBtnTop').addEventListener('click', jitterToggle);
        
        function jitterToggle() {
            const jitterLevels = [0, 0.1, 0.25, 0.5];
            const labels = ['0%', '10%', '25%', '50%'];
            let currentIndex = jitterLevels.indexOf(jitterAmount);
            currentIndex = (currentIndex + 1) % jitterLevels.length;
            jitterAmount = jitterLevels[currentIndex];
            
            // Update visual controls
            document.getElementById('jitterBtn').textContent = `📊 Jitter: ${labels[currentIndex]}`;
            document.getElementById('jitterBtnTop').textContent = `📊 Jitter: ${labels[currentIndex]}`;
            document.getElementById('jitterLevel').textContent = labels[currentIndex];
            
            // Sync with audio jitter
            audioJitterAmount = jitterAmount;
            const percentValue = Math.round(jitterAmount * 100);
            document.getElementById('audioJitterSlider').value = percentValue;
            document.getElementById('audioJitterValue').textContent = percentValue + '%';
            document.getElementById('globalJitterSlider').value = percentValue;
            document.getElementById('globalJitterValue').textContent = percentValue + '%';
        }
        
        document.getElementById('resetBtn').addEventListener('click', resetSimulation);
        document.getElementById('resetBtnTop').addEventListener('click', resetSimulation);
        
        function resetSimulation() {
            time = 0;
            goodSamples = [];
            badSamples = [];
            lastSampleTime = { good: 0, bad: 0 };
            
            document.getElementById('goodHand').style.transform = 'rotate(0deg)';
            document.getElementById('badHand').style.transform = 'rotate(0deg)';
            
            // Stop audio if playing
            if (isAudioPlaying) {
                stopAudio();
            }
            
            // Reset jitter to default
            jitterAmount = 0.1;
            audioJitterAmount = 0.1;
            document.getElementById('jitterBtn').textContent = '📊 Jitter: 10%';
            document.getElementById('jitterBtnTop').textContent = '📊 Jitter: 10%';
            document.getElementById('jitterLevel').textContent = '10%';
            document.getElementById('audioJitterSlider').value = 10;
            document.getElementById('audioJitterValue').textContent = '10%';
            
            // Reset speed
            speed = 1;
            document.getElementById('speedBtn').textContent = '🎚️ Speed: Normal';
            document.getElementById('speedBtnTop').textContent = '🎚️ Speed: Normal';
            
            if (!isPlaying) {
                drawStaticWaveform();
            }
        }
        
        window.addEventListener('resize', () => {
            setupCanvas();
            if (!isPlaying) {
                drawStaticWaveform();
            }
        });
        
        init();
    </script>
</body>
</html>
